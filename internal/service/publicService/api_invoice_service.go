/*
 * Public OpenAPI
 *
 * This is the public OpenAPI definition.
 *
 * API version: 1.0.0
 * Generated by: OpenAPI Generator (https://openapi-generator.tech)
 */

package publicService

import (
	"context"
	"errors"
	"net/http"

	"github.com/CHainGate/backend/internal/model"
	"github.com/CHainGate/backend/internal/repository"
	"github.com/CHainGate/backend/internal/service"
	"github.com/CHainGate/backend/internal/utils"
	"github.com/CHainGate/backend/pkg/enum"
	"github.com/CHainGate/backend/publicApi"
	"github.com/google/uuid"
)

// InvoiceApiService is a service that implements the logic for the InvoiceApiServicer
// This service should implement the business logic for every endpoint for the InvoiceApi API.
// Include any external packages or services that will be required by this service.

type InvoiceApiService struct {
	authenticationService service.IAuthenticationService
	publicApiService      service.IPublicPaymentService
	paymentRepository     repository.IPaymentRepository
}

// NewInvoiceApiService creates a default api service
func NewInvoiceApiService(
	publicApiService service.IPublicPaymentService,
	authenticationService service.IAuthenticationService,
	paymentRepository repository.IPaymentRepository,
) publicApi.InvoiceApiServicer {
	return &InvoiceApiService{authenticationService, publicApiService, paymentRepository}
}

// NewInvoice - Create a new invoice
func (s *InvoiceApiService) NewInvoice(_ context.Context, xAPIKEY string, invoiceRequestDto publicApi.InvoiceRequestDto) (publicApi.ImplResponse, error) {
	merchant, apiKey, err := s.authenticationService.HandleApiAuthentication(xAPIKEY)
	if err != nil {
		if err.Error() == "not authorized" {
			return publicApi.Response(http.StatusForbidden, nil), err
		}
		return publicApi.Response(http.StatusInternalServerError, nil), err
	}

	priceCurrency, ok := enum.ParseStringToFiatCurrencyEnum(invoiceRequestDto.PriceCurrency)
	if !ok {
	}

	if len(merchant.Wallets) == 0 {
		return publicApi.Response(http.StatusBadRequest, nil), errors.New("no outcome addresses defined. ")
	}

	initialState := model.PaymentState{
		PaymentState: enum.CurrencySelection,
		PayAmount:    model.NewBigIntFromInt(0),
		ActuallyPaid: model.NewBigIntFromInt(0),
	}

	payment := model.Payment{
		Base:           model.Base{ID: uuid.New()},
		MerchantId:     merchant.ID,
		Mode:           apiKey.Mode,
		PriceAmount:    invoiceRequestDto.PriceAmount,
		PriceCurrency:  priceCurrency,
		PayCurrency:    enum.NOT_SELECTED,
		PaymentStates:  []model.PaymentState{initialState},
		CallbackUrl:    invoiceRequestDto.CallbackUrl,
		SuccessPageUrl: invoiceRequestDto.SuccessPageUrl,
		FailurePageUrl: invoiceRequestDto.FailurePageUrl,
	}

	err = s.paymentRepository.Create(&payment)
	if err != nil {
		return publicApi.Response(http.StatusInternalServerError, nil), err
	}

	actuallyPaid, err := utils.ConvertAmountToBase(payment.PayCurrency, payment.PaymentStates[0].ActuallyPaid.Int)
	if err != nil {
		return publicApi.Response(http.StatusInternalServerError, nil), err
	}

	paymentResponseDto := publicApi.InvoiceResponseDto{
		Id:             payment.ID.String(),
		PayAddress:     payment.PayAddress,
		PriceAmount:    payment.PriceAmount,
		PriceCurrency:  payment.PriceCurrency.String(),
		ActuallyPaid:   actuallyPaid.String(),
		CallbackUrl:    payment.CallbackUrl,
		SuccessPageUrl: payment.SuccessPageUrl,
		FailurePageUrl: payment.FailurePageUrl,
		InvoiceUrl:     utils.Opts.PaymentBaseUrl + payment.ID.String(),
		PaymentState:   payment.PaymentStates[0].PaymentState.String(),
		CreatedAt:      payment.CreatedAt,
		UpdatedAt:      payment.UpdatedAt,
	}
	return publicApi.Response(http.StatusCreated, paymentResponseDto), nil
}
